<!DOCTYPE html>
<meta charset="utf-8" />
<meta name=help href="https://privacycg.github.io/storage-partitioning/">
<title>iframe</title>
<script src="/common/dispatcher/dispatcher.js"></script>
<script src="/common/utils.js"></script>
<script src="../helpers.js"></script>
<script src="../../IndexedDB/support-promises.js"></script>

<body>
  <script>
    (async () => {
      let usage_details = {};
      const write_size = 1024 * 100;
      const object_store_name = token();
      const db_name = self.location.pathname;

      await indexedDB.deleteDatabase(db_name);
      const db = await createDB(db_name, object_store_name, null);

      usage_details.before_write =
        (await navigator.storage.estimate()).usageDetails.indexedDB || 0;

      const transaction = db.transaction(object_store_name, 'readwrite');
      const value_to_store = largeValue(write_size, Math.random() * 255);
      transaction.objectStore(object_store_name).add(value_to_store, 1);

      await transactionPromise(transaction);

      usage_details.after_write =
        (await navigator.storage.estimate()).usageDetails.indexedDB || 0;

      const target = window.opener || window.parent;
      if (target)
        target.postMessage(/*payload=*/usage_details, '*');

      db.close();
      indexedDB.deleteDatabase(db_name);
    }
    )();
  </script>
</body>

</html>
